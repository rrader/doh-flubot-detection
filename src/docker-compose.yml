version:  '3'
services:
  notebook:
      build: ./juplab
      volumes:
        - ${LOCAL_WORKING_DIR}:/home/${NB_USER}/work
        - ${LOCAL_DATASETS}:/home/${NB_USER}/datasets
        - ${LOCAL_CONFIG}:/home/${NB_USER}/.jupyter
        - ${LOCAL_SSL_CERTS}:/etc/ssl/notebook
        - ../:/home/${NB_USER}/repository
      ports:
        - ${PORT}:8888
        - "8787:8787"
        - 4444:4444
      environment:
        - CHOWN_HOME=yes
        - CHOWN_HOME_OPTS=-R
      env_file:
        - .env
      working_dir: /home/${NB_USER}
      command: bash -c "openssl req -x509 -nodes -newkey rsa:2048 -keyout /etc/ssl/notebook/jupyter.pem -out /etc/ssl/notebook/jupyter.pem \
                -subj '/C=CZ/ST=Brno/L=Brno/O=VUT/OU=FIT/CN=rrader.github.io'; \
       start-notebook.sh \
        --ip 0.0.0.0 --allow-root \
        --NotebookApp.password=${ACCESS_TOKEN} \
        --NotebookApp.certfile=/etc/ssl/notebook/jupyter.pem"
